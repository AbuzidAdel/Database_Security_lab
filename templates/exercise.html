{% extends "base.html" %}

{% block title %}{{ exercise.title }} - Database Security Lab{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active">{{ exercise.title }}</li>
    </ol>
</nav>

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h1>{{ exercise.title }}
                    {% if exercise.is_hidden %}
                    <span class="badge bg-warning text-dark ms-2">Hidden</span>
                    {% endif %}
                </h1>
                <p class="lead">{{ exercise.content }}</p>
            </div>
            <div id="adminControls" style="display: none;">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="editExercise()">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="addStep()">
                        <i class="bi bi-plus"></i> Add Step
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteExercise()">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h2>Steps</h2>
        
        {% if steps %}
        <div class="accordion" id="stepsAccordion">
            {% for step in steps %}
            <div class="accordion-item {% if step.is_hidden %}hidden-content{% endif %}">
                <h2 class="accordion-header" id="heading{{ loop.index }}">
                    <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" 
                            aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" 
                            aria-controls="collapse{{ loop.index }}">
                        <strong>Step {{ step.order or loop.index }}:</strong>&nbsp;{{ step.title }}
                        {% if step.is_hidden %}
                        <span class="badge bg-warning text-dark ms-2">Hidden</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" 
                     aria-labelledby="heading{{ loop.index }}" data-bs-parent="#stepsAccordion">
                    <div class="accordion-body">
                        <div class="step-content">
                            {{ step.content | safe }}
                        </div>
                        <div class="mt-3">
                            <a href="/step/{{ step.id }}" class="btn btn-outline-primary btn-sm">View Full Step</a>
                            <div class="admin-step-controls d-inline-block ms-2" style="display: none !important;">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="editStep('{{ step.id }}')">
                                    Edit
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteStep('{{ step.id }}')">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info" role="alert">
            <h4 class="alert-heading">No steps available</h4>
            <p>This exercise doesn't have any steps yet.</p>
            <div id="addStepPrompt" style="display: none;">
                <hr>
                <button type="button" class="btn btn-success" onclick="addStep()">Add First Step</button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Exercise Modal -->
<div class="modal fade" id="editExerciseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Exercise</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editExerciseForm">
                    <div class="mb-3">
                        <label for="editExerciseTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="editExerciseTitle" value="{{ exercise.title }}">
                    </div>
                    <div class="mb-3">
                        <label for="editExerciseContent" class="form-label">Description</label>
                        <textarea class="form-control" id="editExerciseContent" rows="4">{{ exercise.content }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editExerciseOrder" class="form-label">Order</label>
                        <input type="number" class="form-control" id="editExerciseOrder" value="{{ exercise.order or 0 }}">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editExerciseHidden" 
                               {% if exercise.is_hidden %}checked{% endif %}>
                        <label class="form-check-label" for="editExerciseHidden">
                            Hidden (only visible to admins)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateExercise()">Update Exercise</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Step Modal -->
<div class="modal fade" id="addStepModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Step</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStepForm">
                    <div class="mb-3">
                        <label for="stepTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="stepTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="stepContent" class="form-label">Content</label>
                        <div id="contentEditor" style="height: 300px; border: 1px solid #ced4da; border-radius: 0.375rem;"></div>
                        <textarea id="stepContent" style="display: none;"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="stepOrder" class="form-label">Order</label>
                        <input type="number" class="form-control" id="stepOrder" value="{{ (steps|length) + 1 }}">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="stepHidden">
                        <label class="form-check-label" for="stepHidden">
                            Hidden (only visible to admins)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createStep()">Add Step</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    let quill;
    const exerciseId = '{{ exercise.id }}';

    // Show admin controls if user is admin
    if (currentUser && currentUser.is_admin) {
        document.getElementById('adminControls').style.display = 'block';
        document.querySelectorAll('.admin-step-controls').forEach(el => {
            el.style.display = 'inline-block !important';
        });
        
        {% if not steps %}
        document.getElementById('addStepPrompt').style.display = 'block';
        {% endif %}
    }

    function editExercise() {
        new bootstrap.Modal(document.getElementById('editExerciseModal')).show();
    }

    async function updateExercise() {
        const title = document.getElementById('editExerciseTitle').value;
        const content = document.getElementById('editExerciseContent').value;
        const order = parseInt(document.getElementById('editExerciseOrder').value);
        const isHidden = document.getElementById('editExerciseHidden').checked;

        try {
            const response = await apiCall(`/api/content/${exerciseId}`, {
                method: 'PUT',
                body: JSON.stringify({
                    title: title,
                    content: content,
                    order: order,
                    is_hidden: isHidden
                })
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editExerciseModal')).hide();
                showAlert('Exercise updated successfully!', 'success');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                const error = await response.json();
                showAlert(error.detail || 'Failed to update exercise', 'danger');
            }
        } catch (error) {
            showAlert('Network error. Please try again.', 'danger');
        }
    }

    function addStep() {
        // Initialize Quill editor
        if (!quill) {
            quill = new Quill('#contentEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });
        }
        
        new bootstrap.Modal(document.getElementById('addStepModal')).show();
    }

    async function createStep() {
        const title = document.getElementById('stepTitle').value;
        const content = quill.root.innerHTML;
        const order = parseInt(document.getElementById('stepOrder').value);
        const isHidden = document.getElementById('stepHidden').checked;

        if (!title || !content) {
            showAlert('Please fill in all required fields', 'warning');
            return;
        }

        try {
            const response = await apiCall('/api/content', {
                method: 'POST',
                body: JSON.stringify({
                    title: title,
                    content: content,
                    content_type: 'step',
                    parent_id: exerciseId,
                    order: order,
                    is_hidden: isHidden
                })
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addStepModal')).hide();
                showAlert('Step created successfully!', 'success');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                const error = await response.json();
                showAlert(error.detail || 'Failed to create step', 'danger');
            }
        } catch (error) {
            showAlert('Network error. Please try again.', 'danger');
        }
    }

    async function deleteExercise() {
        if (!confirm('Are you sure you want to delete this exercise? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await apiCall(`/api/content/${exerciseId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showAlert('Exercise deleted successfully!', 'success');
                
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
            } else {
                const error = await response.json();
                showAlert(error.detail || 'Failed to delete exercise', 'danger');
            }
        } catch (error) {
            showAlert('Network error. Please try again.', 'danger');
        }
    }

    async function editStep(stepId) {
        // This would open a modal similar to addStep but for editing
        showAlert('Edit step functionality coming soon!', 'info');
    }

    async function deleteStep(stepId) {
        if (!confirm('Are you sure you want to delete this step?')) {
            return;
        }

        try {
            const response = await apiCall(`/api/content/${stepId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showAlert('Step deleted successfully!', 'success');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                const error = await response.json();
                showAlert(error.detail || 'Failed to delete step', 'danger');
            }
        } catch (error) {
            showAlert('Network error. Please try again.', 'danger');
        }
    }
</script>
{% endblock %}